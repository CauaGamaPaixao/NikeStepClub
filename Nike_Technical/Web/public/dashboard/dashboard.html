<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="dashboardStyle.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Radio+Canada+Big:ital,wght@0,400..700;1,400..700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="header">
        <div class="secao1">
            <div class="conteudoSecao1">
                <img src="assets/user.png" alt="" width="220px">
                <span id="span_header"></span>
                <img src="assets/NikeLogo.png" alt="" width="90px">
            </div>
        </div>
        <div class="secao2">
            <div class="conteudoSecao2">
                <div class="colecao">
                    <div class="imagemColecao">
                        <img src="assets/ColecaoGrid.png" alt="">
                    </div>
                    <div class="textoColecao">
                        <span>Sua Coleção</span>
                    </div>
                </div>
                <div class="sair">
                    <a href="../index.html"></a>
                    <div class="imagemSair">
                        <img src="assets/Sair.png" alt="">
                    </div>
                    <div class="textoSair">
                        <a href="../index.html">Sair</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="dash">
        <div class="dashHeader">
            <div class="KPIcard">
                <div class="KPItexto">
                    <span>Modelo <br> Mais Caro</span>
                </div>
                <div class="KPIimagem">
                    <span id="valor_caro" style="color: darkred;"></span>
                </div>
            </div>
            <div class="KPIcard">
                <div class="KPItexto">
                    <span>Modelo <br> Mais Barato</span>
                </div>
                <div class="KPIimagem">
                    <span id="valor_barato" style="color: darkgreen"></span>
                </div>
            </div>
            <div class="KPIcard">
                <div class="KPItexto">
                    <span>Foco da <br> Coleção</span>
                </div>
                <div class="KPIimagem">
                    <span id="foco_colecao"></span>
                </div>
            </div>
        </div>
        <div class="valorColecao">
            <div class="cardValor">
                <div class="valorTexto">
                    <span>Sua coleção atual está avaliada no valor de </span>
                </div>
                <div class="valorDinheiro">
                    <span id="kpi_total"></span>
                </div>
            </div>
        </div>
        <div class="graficos">
            <div class="cardGrafico">
                <div class="card">
                    <div class="grafico">
                        <h3>Comparativo de Preços</h3>
                        <canvas id="graficoBarra"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="grafico">
                        <h3>Foco da coleção</h3>
                        <canvas id="graficoPizza"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    var imagemColecao = document.getElementById('imagem_colecao');
    var idUsuario = sessionStorage.ID_USUARIO;
    var nome = sessionStorage.NOME_USUARIO;
    span_header.innerHTML = `Seja bem vindo ${nome}`
    var focoColecao = ``;
    
    function valorTotal(dados){
        var total = Number(dados[0].Valor) + Number(dados[1].Valor) + Number(dados[2].Valor) + Number(dados[3].Valor) + Number(dados[4].Valor)

        kpi_total.innerHTML = total.toLocaleString('pt-BR', {style: "currency", currency: "BRL"});

    }

    function valorMaisCaro(dados){
        var valorCaro = Number(dados[0].Valor)
        valor_caro.innerHTML = valorCaro.toLocaleString('pt-BR', {style: "currency", currency: "BRL"})

    }

    function valorMaisBarato(dados){
        var valorBarato = Number(dados[4].Valor)
        valor_barato.innerHTML = valorBarato.toLocaleString('pt-BR', {style: "currency", currency: "BRL"})
    }

    function montarPizza(dados){
            var lista = [dados[0].Tipo, dados[1].Tipo, dados[2].Tipo, dados[3].Tipo, dados[4].Tipo];
            var esporte = 0;
            var casual = 0
            for (var i = 0; i < lista.length; i++){
                if (lista[i] == 'Casual') {
                    casual++
                } else{
                    esporte++;
                }
            }

            if (casual > esporte){
                focoColecao = 'Casual'
            } else {
                focoColecao = 'Esportiva'
            }

            foco_colecao.innerHTML = focoColecao;
                
            console.log(lista)
            var totalTipo = casual + esporte;
            var casualPct = ((casual / totalTipo) * 100).toFixed(0);
            var esportivaPct = ((esporte / totalTipo) * 100).toFixed(0);

            var graficoPizza = document.getElementById('graficoPizza').getContext('2d');
            
            new Chart(graficoPizza, {
            type: 'doughnut',
            data: {
                labels: [`Casual (${casualPct}%)`, `Esportiva (${esportivaPct}%)`],
                datasets: [{
                    data: [casual, esporte],
                    backgroundColor: ['#D3AF37', 'darkgreen'], 
                    hoverOffset: 4
                }]
            },
            options: {
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        title: {
                            display: true,
                            text: '(%)'
                        },
                        beginAtZero: true,
                    },
                },
            }
      });
    }


    function montarGrafico (dados){
        var graficoBarra = document.getElementById('graficoBarra').getContext('2d');
        new Chart(graficoBarra, {
            type: 'bar',
            data: {
                labels: [dados[0].Tenis, dados[1].Tenis, dados[2].Tenis, dados[3].Tenis, dados[4].Tenis],
                datasets: [{
                    label: 'Valor (R$)',
                    data: [dados[0].Valor, dados[1].Valor, dados[2].Valor, dados[3].Valor, dados[4].Valor],
                    backgroundColor: '#D3AF37',
                    borderColor: '#D3AF37',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        title: {
                            display: false,
                        },
                        beginAtZero: true,
                    },
                },
            }
        });
    }
    document.addEventListener('DOMContentLoaded', () => {

            fetch(`/medidas/listar/${idUsuario}`).then(function (res) {
            if (res.ok) {
            res.json().then(function (response) {
                console.log(`Dados recebidos: ${JSON.stringify(response)}`)
                montarGrafico(response)
                valorTotal(response)
                montarPizza(response)
                valorMaisCaro(response)
                valorMaisBarato(response)

            })
        } 
        else {
            console.log(`Erro ao carregar gráfico`)
        }
        
    });
});




</script>